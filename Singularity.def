Bootstrap: docker
From: continuumio/miniconda3:latest

%post
    apt-get update -y && apt-get upgrade -y

    # Set up bash for conda
    conda init bash

    # Create working dir and move into it
    mkdir -p /benchmark
    cd /benchmark

    # Copy environment.yml (will be added in %files)
    conda env create -f /benchmark/environment_chembed.yml
    echo "conda activate tartarus_chembed" >> ~/.bashrc

    # XTB env setup
	eval "$(conda shell.bash hook)"
	conda activate tartarus_chembed
    echo "export XTBHOME=\$CONDA_PREFIX" > $CONDA_PREFIX/etc/conda/activate.d/env.sh
    echo "source \$CONDA_PREFIX/share/xtb/config_env.bash" >> $CONDA_PREFIX/etc/conda/activate.d/env.sh

	# install additional packages
	pip install h5py scikit-learn geometric pyberny loguru wurlitzer sqlalchemy
	pip install -i https://test.pypi.org/simple/ geodesic-interpolate
	pip install git+https://github.com/kjelljorner/polanyi

	# install chembed
	pip install /opt/chembed


    # Create data dir and set permissions
    mkdir -p /data
    chmod 777 /benchmark/tartarus/data/qvina
    chmod 777 /benchmark/tartarus/data/smina

%files
    ./tartarus_chembed_env.yml /benchmark/environment_chembed.yml
    . /benchmark
	/home/hugo/chembed /opt/chembed

%environment
    # This runs every time the container is launched
    source /opt/conda/etc/profile.d/conda.sh
    conda activate tartarus_chembed
    export XTBHOME=$CONDA_PREFIX
    source $CONDA_PREFIX/share/xtb/config_env.bash

%runscript
    # This is the entrypoint
    exec conda run --no-capture-output -n tartarus python /benchmark/benchmark.py

